---
title: 位置广播系统
date: 2024-11-29 17:20:29
tags: Miscellaneous
aside: false
cover: https://i.postimg.cc/t4k1NjCm/37634.jpg
---

{% tip cogs %} 
此页面引用了leaflet.js，以及外部字体。

请确保你的页面启动了Javascript以访问该页面 
{% endtip %}

---

在这里可以看到我的当前位置哦~

<link href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    /* 设置地图容器的圆角样式 */
    #map-container {
        font-family: 'SUSE', sans-serif;
        border-radius: 15px; /* 圆角大小，可根据需求调整 */
        overflow: hidden;    /* 确保内容裁剪，防止地图超出圆角边界 */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* 可选，添加阴影美化效果 */
    }
    #map {
        height: 500px;
        width: 100%;
        /* margin: 20px 0; */
    }
    .loading {
        top: 50%;
        justify-content: center;
        text-align: center;
        font-size: 0.8em;
        color: gray;
    }
    #map #loading-tip {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
</style>
<div id="map-container">
    <!-- 地图会被渲染到这里 -->
    <div id="map" class="loading">
        <div id="loading-tip">Loading terrain...</div>
    </div>
</div>
<script>
    // 初始化地图
    const map = L.map('map').setView([0, 0], 16); // 初始显示全球地图
    // 添加地图图层
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    // 定义标记变量（确保只使用一个标记）
    let marker = null;
    // 从 API 获取位置信息
    async function fetchLocation() {
        try {
            const response = await fetch('https://location-tracker-a8i5.onrender.com/api/location');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const { latitude, longitude, online } = await response.json();
            if (!latitude && !longitude) return;
            const tip = online ? 
                `指挥官开启了位置共享<br>(${latitude.toFixed(2)}, ${longitude.toFixed(2)})<br>位置实时更新中...` :
                `指挥官似乎暂时离开了...<br>(${latitude.toFixed(2)}, ${longitude.toFixed(2)})<br>自动为您保留了最后一次在线的位置~`
            // 更新地图视图
            map.setView([latitude, longitude]);
            // 如果标记已存在，更新位置；否则添加新标记
            if (marker) {
                marker.setLatLng([latitude, longitude]);
                marker.bindPopup(tip);
            } else {
                marker = L.marker([latitude, longitude])
                    .addTo(map)
                    .bindPopup(tip)
                    .openPopup();
            }
        } catch (error) {
            console.error('Error fetching location:', error);
            document.getElementById('map').innerHTML = `<div id="loading-tip">-- 未曾设想的道路 --<br><br>我们似乎出现了一些小问题~<br>这肯定是由于指挥官处理不当！<br>写了一堆晦涩难懂的东西！~<br><br>我们知道的一切：<span style="color: #ff5555">${error}</span><br>如果你愿意向指挥官报告这个问题，指挥官会万分感谢你的！</div>`;
        }
    }
    // 初次加载位置
    fetchLocation();
    // 每隔 10 秒更新一次位置
    setInterval(fetchLocation, 10000);
</script>